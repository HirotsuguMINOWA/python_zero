# Pythonが動く仕組み

* コンピュータはなぜ動くのか？
* Pythonが動く仕組み
* 抽象構文木
* dis.dis
* 仮想マシンハック

## コンピュータはなぜ動くのか？

これまで、ブラウザ上でプログラムを入力し、実行させ、その結果を表示させてきた。Pythonのプログラムはクラウド上で実行されたが、そのブラウザを実行しているのは皆さんの目の前にあるのはコンピュータである。コンピュータとはcomputeするもの、つまり計算機であり、何かしら計算してその結果を表示することを繰り返す機械である。では、そもそもプログラムとはどうやって動いているのだろうか？せっかくプログラミングを覚えるのだから、計算機がどういう仕組みで動いているのか知っておいた方が良いだろう。なお、私は古い人間なので、コンピュータのことをどうしても「計算機」と呼んでしまう。以後、パソコンやCPUなどを指して「計算機」と呼ぶのでそのつもりでいて欲しい。

いま、目の前にある計算機は、ディスプレイ(表示装置)、キーボードやマウス(入力装置)、CPU(中央演算処理装置)、メモリ(記憶装置)などから構成されている。ディスクなどのストレージやネットワークなどの通信装置については今は忘れよう。このうちCPUがもっとも重要な装置であるが、やっていることは非常に単純で、

* メモリから命令とデータを取ってくる
* 命令を解釈し、データを演算器に投げる
* 演算器から返ってきた結果をメモリに書き戻す

ということをひたすら繰り返しているに過ぎない。「命令」も一種のデータであり、メモリに置いてあることに注意しよう。演算器というのは、文字通り演算する機械である。例えば足し算をしたければ加算器を、掛け算をしたければ乗算器が必要になる。また、整数演算と浮動小数点演算は全くことなる演算器を用いる。

TODO: 命令サイクルのイラスト

さて、計算機が解釈できるのは数字だけである。したがって、人間が計算機に命令するためには、機械語(マシン語)と呼ばれる数字の羅列を使う必要がある。コンピュータとは計算機であり、計算とはデータに四則演算などの演算をすることである。したがって、計算機に何か計算させたければ「何を(データ)」「どうするか(命令)」がセットである必要があることがわかるだろう。
機械語というと難しそうだが、結局のところ「何をどうするか」を羅列しているに過ぎない。
例えば一桁の整数を二つ受け取って四則演算をする計算機があったとしよう。四則演算をするので、演算は加算、減算、乗算、除算の四種類である。なのでそれぞれに0,1,2,3の数字を割り当てよう。四則演算をするには、整数が二つ必要だ。その数字も並べよう。例えば「034」という数字列は「3+4」を、「185」は「8-5」を表す。計算機は、メモリから三つの数字をとってきて、最初の数字を見て「どの演算器に投げるか」を決める(命令を最初に置いたのはそのためだ)。そして続く二つのデータを演算器に投げる。かなり単純化されているが、これが機械語である。もし興味がある人がいたら、tanakmuraさんの[実践的低レベルプログラミング](https://tanakamura.github.io/pllp/docs/index.html)の[x86_64 機械語入門](https://tanakamura.github.io/pllp/docs/x8664_language.html)を参照せよ。

TODO: マシン語のイラスト

## プログラム言語とは

さて、計算機が解釈できるのは機械語だけである。機械語は難しくはないが、手で書くのは非常に面倒だ。なので、人間が理解できる形式でプログラムを書き、それを計算機が理解できる形式に変換してやろう、と思うのは自然であろう。その「人間が理解できる形式」がプログラム言語と呼ばれるものである。プログラム言語には、大きく分けてコンパイル言語とインタプリタの二種類がある。C++などはコンパイル言語の代表格的な言語である。コンパイラと呼ばれるプログラムが、人間の書いたプログラムをあらかじめ全て機械語に翻訳してから実行する。インタプリタとは、人間の書いたコードを逐次的に解釈しながら実行する方式であり、Pythonもインタプリタに属す。しかし、プログラムをそのまま解釈、実行すると遅いため、Pythonは「バイトコード」と呼ばれる中間形式を出力し、それを実行することで高速化を図る。バイトコードを実行するプログラムを仮想マシン(Virtual Machine, VM)と呼ぶ。Javaは事前にプログラムをコンパイルするが、出力するのは現実の機械の機械語ではなく、仮想機械の機械語であり、それを仮想機械上で実行する。また、clangは、LLVMという仕組みを使い、まず仮想機械の機械語を出力してから現実の機械語に変換する。

TODO: このあたりの言語の実行の仕組みの図解
TODO: VMの説明。Javaとの比較など
TODO: レジスタマシン、スタックマシンの説明もする？高度すぎか？

## Pythonが動く仕組み

TODO: astによる抽象構文木の確認
TODO: dis.disによるバイトコードの確認


